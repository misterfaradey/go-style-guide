# Избегайте `init()`

По возможности избегайте `init()`. Когда `init()` неизбежен или желателен, код
должен попытаться это сделать:

1. Быть полностью детерминированным, независимо от программной среды или вызова.
2. Избегайте зависимости от порядка выполнения или побочных эффектов других функций init().
   Хотя порядок выполнения init() хорошо известен, код может меняться, и, следовательно,
   взаимосвязи между функциями init() могут сделать код хрупким и
   подверженным ошибкам.
3. Избегайте доступа к глобальным данным или состоянию среды или манипулирования ими, таким как машинная
   информация, переменные среды, рабочий каталог, программа
   аргументы/входные данные и т.д.
4. Избегайте операций ввода-вывода, включая вызовы файловой системы, сети и системные вызовы.

Код, который не может удовлетворить этим требованиям, скорее всего, является вспомогательным и должен
вызываться как часть функции main() (или где-либо еще в жизненном цикле программы) или быть
написан как часть самой функции main(). В частности, библиотеки, предназначенные
для использования другими программами, должны быть полностью
детерминированными и не выполнять "магию инициализации".

<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>

```go
type Foo struct {
    // ...
}

var _defaultFoo Foo

func init() {
    _defaultFoo = Foo{
        // ...
    }
}
```

</td><td>

```go
var _defaultFoo = Foo{
    // ...
}

// или, что еще лучше, для удобства тестирования:

var _defaultFoo = defaultFoo()

func defaultFoo() Foo {
    return Foo{
        // ...
    }
}
```

</td></tr>
<tr><td>

```go
type Config struct {
    // ...
}

var _config Config

func init() {
    // Bad: на основе текущего каталога
    cwd, _ := os.Getwd()

    // Bad: I/O
    raw, _ := os.ReadFile(
        path.Join(cwd, "config", "config.yaml"),
    )

    yaml.Unmarshal(raw, &_config)
}
```

</td><td>

```go
type Config struct {
    // ...
}

func loadConfig() Config {
    cwd, err := os.Getwd()
    // handle err

    raw, err := os.ReadFile(
        path.Join(cwd, "config", "config.yaml"),
    )
    // handle err

    var config Config
    yaml.Unmarshal(raw, &config)

    return config
}
```

</td></tr>
</tbody></table>

Учитывая вышесказанное, некоторые ситуации, в которых использование it() может быть предпочтительным или
необходимым, могут включать в себя:

- Сложные выражения, которые нельзя представить в виде отдельных назначений.
- Подключаемые перехватчики, такие как диалекты базы данных/sql, реестры типов кодировок и т.д.
- Оптимизация [облачных функций Google] и других форм детерминированных
  предварительных вычислений.

  [Облачные функции Google]: https://cloud.google.com/functions/docs/bestpractices/tips#use_global_variables_to_reuse_objects_in_future_invocations
