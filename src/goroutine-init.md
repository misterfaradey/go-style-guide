# Никаких подпрограмм в `init()`

Функции `init()` не должны создавать подпрограммы.
Смотрите также [Избегайте init()](init.md).

Если пакету требуется фоновая подпрограмма,
он должен предоставить доступ к объекту, который отвечает за управление временем
жизни подпрограмм.
Объект должен предоставлять метод (`Close`, `Stop`, `Shutdown`, и т.д.).
это сигнализирует об остановке фоновой программы и ожидает ее завершения.

<table>
<thead><tr><th>Bad</th><th>Good</th></tr></thead>
<tbody>
<tr><td>

```go
func init() {
  go doWork()
}

func doWork() {
  for {
    // ...
  }
}
```

</td><td>

```go
type Worker struct{ /* ... */ }

func NewWorker(...) *Worker {
  w := &Worker{
    stop: make(chan struct{}),
    done: make(chan struct{}),
    // ...
  }
  go w.doWork()
}

func (w *Worker) doWork() {
  defer close(w.done)
  for {
    // ...
    case <-w.stop:
      return
  }
}

// Shutdown приказывает работнику остановиться
// и ждет, пока он не завершит работу.
func (w *Worker) Shutdown() {
  close(w.stop)
  <-w.done
}
```

</td></tr>
<tr><td>

Запускает фоновую подпрограмму без каких-либо условий, когда пользователь экспортирует этот пакет.
Пользователь не имеет никакого контроля над подпрограммой или средств ее остановки.

</td><td>

Запускает worker только по запросу пользователя.
Предоставляет средство завершения работы worker, чтобы пользователь мог освободить
ресурсы, используемые worker.

Обратите внимание, что вам следует использовать "WaitGroup", если worker управляет несколькими
подпрограммами.
Смотрите [Дождитесь завершения выполнения подпрограммы](goroutine-exit.md).

</td></tr>
</tbody></table>
